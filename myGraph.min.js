$(document).ready(function(){for(var d,s="#FFBABA",e=parseInt($(".range_yMin").val()),n=parseInt($(".range_yMax").val()),a=parseInt($(".start_x").val()),t=parseInt($(".end_x").val())-a+1,p=[],u=0;u<t;u++)p.push([a+u,0]);var o,i,r,l=!1,f=null,g=null,h="pencil",v=[-9999999999,9999999999];function c(e,n){for(var a=Dygraph.pageX(e)-Dygraph.findPosX(n.graphDiv),e=Dygraph.pageY(e)-Dygraph.findPosY(n.graphDiv),a=n.toDataCoords(a,e),t=a[0],e=a[1],o=n.numRows(),i=-1,r=-1,s=0;s<o;s++){var l=n.getValue(s,0),l=Math.abs(l-t);(r<0||l<r)&&(r=l,i=s)}if(-1!=i){null===f&&(f=i,g=e);var u=(e-g)/(i-f);i==f&&(u=0);for(var d,a=Math.min(f,i),c=Math.max(f,i),s=a;s<=c;s++)"pencil"==h&&(d=g+u*(s-f),d=Math.max(v[0],Math.min(d,v[1])),null==(p[s][1]=d)||isNaN(d));f=i,g=e,n.updateOptions({file:p}),n.setSelection(i)}}function x(){l=!1,g=f=null}function m(e,n,a){var t=(e.detail?-1*e.detail:e.wheelDelta/40)/50;e.offsetX&&e.offsetY||(e.offsetX=e.layerX-e.target.offsetLeft,e.offsetY=e.layerY-e.target.offsetTop);var o,i,r,s,l,u,u=(o=n,i=e.offsetX,r=e.offsetY,s=o.toDomCoords(o.xAxisRange()[0],null)[0],l=o.yAxisRange(0),u=o.toDomCoords(null,l[1])[1],i-=s,r-=u,s=o.toDomCoords(o.xAxisRange()[1],null)[0]-s,u=o.toDomCoords(null,l[0])[1]-u,[0==s?0:i/s,1-(0==u?0:r/u)]);!function(e,n,a,t){function o(e,n,a){n=(e[1]-e[0])*n,a=[n*a,n*(1-a)];return[e[0]+a[0],e[1]-a[1]]}a=a||.5,t=t||.5;for(var i=e.yAxisRanges(),r=[],s=0;s<i.length;s++)r[s]=o(i[s],n,t);e.updateOptions({dateWindow:o(e.xAxisRange(),n,a),valueRange:r[0]})}(n,t,u[0],u[1]),Dygraph.cancelEvent(e),b(),k()}o=p,i=e,r=n,d=new Dygraph(document.getElementById("draw_div"),o,{labels:["",""],showLabelsOnHighlight:!0,strokeWidth:1,gridLineColor:"rgb(196, 196, 196)",colors:"rgb(0,0,0)",valueRange:[i,r],drawYGrid:!0,drawYAxis:!0,stepPlot:!1,labelsDivStyles:{background:"transparent","font-family":"Helvetica","font-weight":"none"},interactionModel:{mousedown:function(e,n,a){e.shiftKey?(a.initializeMouseDown(e,n,a),(e.altKey||e.shiftKey)&&Dygraph.startPan(e,n,a)):(a.initializeMouseDown(e,n,a),"zoom"==h?Dygraph.defaultInteractionModel.mousedown(e,n,a):(e.preventDefault?e.preventDefault():(e.returnValue=!1,e.cancelBubble=!0),l=!0,c(e,n)))},mousemove:function(e,n,a){e.shiftKey?a.isPanning&&Dygraph.movePan(e,n,a):"zoom"==h?Dygraph.defaultInteractionModel.mousemove(e,n,a):l&&c(e,n)},mouseup:function(e,n,a){"zoom"==h?Dygraph.defaultInteractionModel.mouseup(e,n,a):x(),n.updateOptions({dateWindow:n.xAxisRange(),valueRange:n.yAxisRange()}),b(),k()},mouseout:function(e,n,a){"zoom"==h&&Dygraph.defaultInteractionModel.mouseout(e,n,a)},dblclick:function(e,n,a){Dygraph.defaultInteractionModel.dblclick(e,n,a)},mousewheel:m,DOMMouseScroll:m}}),window.onmouseup=x;var y=!1;function _(){$("#dataDiv").html("<textarea id='exportDataField'></textarea>"),$("#dataField").text("");var e="",n="",a=$("#separatorList").val();"csv"==a?n=",":"tsv"==a?n="\t":"space"==a?n=" ":"semicolon"==a?n=";":"colon"==a&&(n=":"),"userDefined"==a?($("#userDefinedSeparator").css({visibility:"visible"}),n=$("#userDefinedSeparator").val()):$("#userDefinedSeparator").css({visibility:"hidden"});for(var t=0;t<p.length;t++)e+=p[t][0]+n+p[t][1]+"\n";$("#exportDataField").html(e)}function D(){if(parseFloat($(".start_x").val())<parseFloat($(".end_x").val()))return $(".start_x").css("background","white"),$(".end_x").css("background","white"),O(),1;$(".start_x").css("background",s),$(".end_x").css("background",s),P("x<sub>min</sub> needs to be less than x<sub>max</sub>")}function M(){for(var e=p[0][0],n=p[0][0],a=p[0][1],t=p[0][1],o=0;o<p.length;o++){var i=p[o][0],r=p[o][1];e<i&&(e=i),i<n&&(n=i),a<r&&(a=r),r<t&&(t=r)}t==a&&(t-=.1,a+=.1),$(".range_yMin").val(t),$(".range_yMax").val(a),$(".start_x").val(n),$(".end_x").val(e),d.updateOptions({file:p,valueRange:[t,a],dateWindow:[n,e]}),b(),k()}function b(){var e=d.getOption("valueRange"),n=e[0].toFixed(1),e=e[1].toFixed(1);$(".range_yMin").val(n),$(".range_yMax").val(e)}function k(){var e=d.getOption("dateWindow"),n=e[0].toFixed(1),e=e[1].toFixed(1);$(".range_xMin").val(n),$(".range_xMax").val(e)}function w(){var e=parseFloat($(".range_yMin").val()),n=parseFloat($(".range_yMax").val()),a=parseInt($(".start_x").val()),t=parseInt($(".end_x").val()),o=parseInt(p[0][0]),i=parseInt(p[p.length-1][0]),r=[];if(t==i)if(a<o){var s=a;for(l=0;l<o-a;l++)r.push([s,0]),s++;for(l=0;l<t-o+1;l++)r.push([s,p[l][1]]),s++}else if(a==o)r=p;else for(var s=a-o,l=a;l<t+1;l++)r.push([l,p[s][1]]),s++;else if(t<i)if(a<o){s=a;for(l=0;l<o-a;l++)r.push([s,0]),s++;for(l=0;l<t-o+1;l++)r.push([s,p[l][1]]),s++}else if(a==o)for(s=0,l=a;l<t+1;l++)r.push([l,p[s][1]]),s++;else for(s=a-o,l=a;l<t+1;l++)r.push([l,p[s][1]]),s++;else if(i<t)if(a<o){s=a;for(l=0;l<o-a;l++)r.push([s,0]),s++;for(l=0;l<t-o+1;l++)null==p[l]?r.push([s,0]):r.push([s,p[l][1]]),s++}else if(a==o)for(s=0,l=a;l<t+1;l++)null==p[s]?r.push([l,0]):r.push([l,p[s][1]]),s++;else for(s=0,l=a;l<t+1;l++)null==p[s]?r.push([l,0]):r.push([l,p[s][1]]),s++;p=r;var u=parseInt($(".range_xMin").val()),i=parseInt($(".range_xMax").val());d.updateOptions({file:r,valueRange:[e,n],dateWindow:[u,i]})}function F(){$("#userDefinedFunction").css("background-color","white");var e,n=$("#userDefinedFunction").val(),a=parseInt($(".start_x").val()),t=parseInt($(".end_x").val()),o=[];if(n.match(/[0-9][A-Za-z]/g))$("#userDefinedFunction").css("background-color",s),P("Syntax error in user defined function");else{$("#userDefinedFunction").css("background-color","white"),O();for(var i=a;i<t+1;i++){e=(e=n.replace(/rand\(x\)/g,Math.random())).replace(/x/g,i);try{var r=math.evaluate(e)}catch(e){$("#userDefinedFunction").css("background-color",s),P("Syntax error in user defined function");break}o.push([i,r])}p=o,d.updateOptions({file:p})}}function I(e){var n,a=0;if(-1<e.indexOf("y")?a=1e20:-1<e.indexOf("x")&&(a=1e5),!!((n=$(e).val()).match(/^[+-]\d+$/)||n.match(/^\d+$/)||n.match(/^[+-]\d+\.\d+$/)||n.match(/^\d+\.\d+$/))&&(n=$(e).val(),a=a,Math.abs(n)<a))return $(e).css("background","white"),O(),1;$(e).css("background",s),P("Range field is not valid")}function P(e){$("#informationPanel").css({background:"#FFBABA",border:"1px solid red"}),$("#informationPanel").html(e)}function O(){$("#informationPanel").html(""),$("#informationPanel").css({background:"white",border:"none"})}$(document).on("change mouseup","#separatorList",function(e){_()}),$(document).on("change","#lineType",function(e){var n=$("#lineType").val();"line"==n?d.updateOptions({stepPlot:!1}):"stair"==n&&d.updateOptions({stepPlot:!0})}),$(document).on("click","#dataButton",function(){_()}),$(document).on("focusout","#userDefinedSeparator",function(){_()}),$(document).on("keypress","#userDefinedSeparator",function(e){13==e.keyCode&&_()}),$(document).on("click","#imageButton",function(){$("#dataDiv").html("<img id='demoimg'><img>");var e=document.getElementById("demoimg");Dygraph.Export.asPNG(d,e)}),$(function(){$("#rTest").resizable({maxHeight:850,maxWidth:1600,minHeight:200,minWidth:500})}),$("#rTest").resize(function(){var e=$("#rTest").css("width"),n=$("#rTest").css("height"),n=-50+parseInt(n);$("#draw_div").css({width:e}).css({height:n}),d.resize()}),$(document).on("dblclick","#dataField",function(){$(this).select()}),$(document).on("keypress",".range_yMin,.range_yMax,.range_xMin,.range_xMax,.start_x,.end_x",function(e){13==e.keyCode&&I(".range_yMin")&&I(".range_yMax")&&I(".range_xMin")&&I(".range_xMax")&&D()&&w()}),$(document).on(""),$(document).on("click","#resetDataButton",function(){var e=parseInt($(".start_x").val()),n=parseInt($(".end_x").val())-e+1;p=[];for(var a=0;a<n;a++)p.push([e+a,0]);d.updateOptions({file:p,valueRange:[-10,10]}),b(),k()}),$(document).on("click","#autoscaleButton",function(){M()}),$(document).on("keypress","#userDefinedFunction",function(e){13==e.keyCode&&F()}),$(document).on("change","#dataField",function(e){$("#importDataButton").click()}),$(document).on("click","#importDataButton",function(){0==y&&($("#dataDiv").html("<textarea id='dataField' placeholder='Paste data here'></textarea>"),$("#dataField").text(""),y=!0);var e=$("#dataField").val();if((e=$.trim(e)).match(/[A-Za-z]/g)&&alert("Invalid import data"),""!=e){var n=e.split("\n"),a=[],t=0,o=0,i=",";for(0<e.search(";")?i=";":0<e.search("\t")?i="\t":0<e.search(" ")?i=" ":0<e.search(":")&&(i=":"),u=0;u<n.length;u++){var r=n[u].split(i),s=parseInt(r[0]),r=parseFloat(r[1]);o<r?o=r:r<t&&(t=r),a.push([s,r])}p=a;var l=parseInt(n[0].split(",")[0]),e=parseInt(n[n.length-1].split(",")[0]);$(".start_x").val(l),$(".end_x").val(e),d.updateOptions({file:a,valueRange:[t,o],dateWindow:[l,e]})}}),$("#draw_div").bind("DOMMouseScroll",function(e){return e.originalEvent.detail,m(e,d),!1}),$(".aboutText").click(function(e){$("#popup").bPopup()}),$(".helpText").click(function(e){$("#helpPopup").bPopup()}),$("#userDefinedFunctionLink").click(function(e){$("#userDefinedFunctionPopup").bPopup()}),$(document).ready(function(){$('a[href*="[at]"][href*="[dot]"]').each(function(){var e=$(this).attr("href").split("[at]").join("@").split("[dot]").join(".");$(this).attr("href","mailto:"+e.toLowerCase()),0==$(this).text().length&&$(this).text(e)})}),$(".range_yMin").change(function(){I(".range_yMin")}),$(".range_yMax").change(function(){I(".range_yMax")}),$(".start_x").change(function(){D()&&I(".start_x")}),$(".end_x").change(function(){D()&&I(".end_x")}),$(".functionExample").click(function(){var e=$(this).html();$("#userDefinedFunction").val(e),$("#userDefinedFunctionPopup").bPopup().close(),F(),M()}),$(".spinner").spinner(),$(".spinner").spinner({spin:function(e,n){I(".range_yMin")&&I(".range_yMax")&&I(".start_x")&&I(".end_x")&&D()&&w()}}),$("html").on("mousewheel",function(e){var n,a,t=e.deltaY;e.ctrlKey?(n=parseInt($(".range_yMin").val()),a=parseInt($(".range_yMax").val()),n-=+t,a+=+t,$(".range_yMin").val(n),$(".range_yMax").val(a),d.updateOptions({valueRange:[n,a]})):e.altKey&&(e=parseInt($(".range_xMin").val())-+t,t=parseInt($(".range_xMax").val())+ +t,$(".range_xMin").val(e),$(".range_xMax").val(t),d.updateOptions({dateWindow:[e,t]}))})});
